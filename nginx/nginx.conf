# nginx/nginx.conf

upstream web {
    # web 是 docker-compose.yml 中定义的 Django 服务名，端口 8000
    server web:8000;
}

server {
    listen 80;

    # 静态文件服务：直接由 Nginx 提供，路径与 docker-compose 卷映射一致
    location /static/ {
        alias /app/staticfiles/;
    }

    # 媒体文件服务：直接由 Nginx 提供
    location /media/ {
        alias /app/mediafiles/;
    }

    # 其他请求转发给 Gunicorn (Web 服务)
    location / {
    proxy_pass http://web;
    # 确保这些头部设置存在
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # (可选) CSRF 诊断时可以添加，确保协议正确
    proxy_set_header X-Forwarded-Proto $scheme;
}
}