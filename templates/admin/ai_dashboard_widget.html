<style>
    .ai-dashboard {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }
    .ai-category {
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }
    .ai-category h3 {
        color: #333;
        margin-top: 0;
        font-size: 14px;
        text-transform: uppercase;
        font-weight: bold;
        border-left: 4px solid #447e9b;
        padding-left: 8px;
    }
    .ai-item-card {
        background: white;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .ai-content {
        flex: 1;
        margin-right: 15px;
        font-size: 13px;
    }
    .ai-actions button {
        background-color: #447e9b;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s;
    }
    .ai-actions button:hover {
        background-color: #36657c;
    }
    .status-tag {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 3px;
        background: #eee;
        color: #666;
        margin-right: 5px;
    }
</style>
<div class="ai-dashboard">
    {% for type_key, type_name, items in grouped_items %}
        <div class="ai-category">
            <h3>{{ type_name }}</h3>
            {% if items %}
                {% for item in items %}
                <div class="ai-item-card">
                    <div class="ai-content">
                        <strong>Option {{ item.option_index }}</strong> <span class="status-tag">{{ item.status }}</span><br>
                        <div style="color: #666; margin-top: 4px;">
                            {{ item.content_en|truncatechars:100 }}
                        </div>
                    </div>
                    <div class="ai-actions">
                        <button type="button" onclick="triggerAiTask('{{ item.id }}', this)">
                            {% if type_key == 'script' %} ğŸ¬ ç”Ÿæˆè§†é¢‘
                            {% elif type_key == 'img_prompt' %} ğŸ¨ ç”Ÿæˆå›¾ç‰‡
                            {% else %} ğŸš€ æ‰§è¡Œæ“ä½œ
                            {% endif %}
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="color: #999; font-size: 12px;">æš‚æ— ç”Ÿæˆå†…å®¹</p>
            {% endif %}
        </div>
    {% endfor %}
</div>

<script>
function triggerAiTask(itemId, btnElement) {
    if(!confirm("ç¡®å®šè¦ä½¿ç”¨æ­¤å†…å®¹è§¦å‘åç»­ AI ä»»åŠ¡å—ï¼Ÿ")) return;

    const originalText = btnElement.innerText;
    btnElement.innerText = "å‘é€ä¸­...";
    btnElement.disabled = true;

    fetch(`/products/api/trigger-ai-task/${itemId}/`, {
        method: 'POST',
        headers: {
            // å¦‚æœä½ çš„ Django å¼€å¯äº† CSRFï¼Œè¿™é‡Œå¯èƒ½éœ€è¦æå– cookieï¼Œ
            // ä½†å› ä¸ºæˆ‘ä»¬åœ¨ view ä¸ŠåŠ äº† @csrf_exemptï¼Œè¿™é‡Œå¯ä»¥æš‚æ—¶å¿½ç•¥ï¼Œ
            // ç”Ÿäº§ç¯å¢ƒå»ºè®®åŠ ä¸Š CSRF tokenã€‚
        }
    })
    .then(response => response.json())
    .then(data => {
        if(data.status === 'success') {
            alert("âœ… ä»»åŠ¡å·²æˆåŠŸå‘é€ç»™ n8nï¼");
            btnElement.innerText = "å·²å‘é€";
            btnElement.style.backgroundColor = "#28a745";
        } else {
            alert("âŒ é”™è¯¯: " + data.message);
            btnElement.innerText = originalText;
            btnElement.disabled = false;
        }
    })
    .catch(error => {
        alert("âŒ ç½‘ç»œé”™è¯¯");
        btnElement.innerText = originalText;
        btnElement.disabled = false;
    });
}
</script>